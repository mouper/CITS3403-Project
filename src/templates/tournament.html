{% extends "base.html" %}
{% set readonly = (current_user.id != tournament.created_by) %}

{% block content %}
  <div class="tournament-container">
    <input type="hidden" id="tournamentId" value="{{ tournament.id }}">
    <input type="hidden" id="tournamentFormat" value="{{ tournament.format }}">
    <input type="hidden" id="roundState" value="{% if current_round and current_round.status == 'completed' %}completed{% elif current_round and current_round.status == 'in progress' %}in progress{% else %}pre round{% endif %}">
    <input type="hidden" id="roundTime" value="{{ tournament.round_time_minutes }}">
    <input type="hidden" id="viewState" value="{{ view_state or 'normal' }}">

    <!-- Tournament Header -->
    <div class="intourney-header">
      <h1 class="title2 page-header"><span>{{ tournament.title }}</span></h1>
      <div class="SaveBtn">
        <button id="saveExitBtn"
                {% if readonly %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
          <div class="SaveIcon"></div>
          Save & Exit
        </button>
      </div>
    </div>

    <!-- Meta Info -->
    <div class="tournament-meta">
      <div class="meta-item">
        <span class="meta-label regular1">Type:</span>
        <span class="meta-value medium1">{{ tournament.format|title }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label regular1">Game:</span>
        <span class="meta-value medium1">{{ tournament.game_type }}</span>
      </div>
      <div class="meta-item">
        <span class="meta-label regular1">Status:</span>
        <span class="meta-value medium1">{{ tournament.status|title }}</span>
      </div>
    </div>

    <!-- Round Section -->
    <div class="tournament-round">
      <div class="round-header">
        <h2 class="round-title subheadline">
          ROUND {{ current_round.round_number if current_round else 1 }} â€“
          {% if view_state == 'confirm_results' %}
            CONFIRM RESULTS
          {% elif current_round and current_round.status == 'completed' %}
            COMPLETED
          {% elif current_round and current_round.status == 'in progress' %}
            IN PROGRESS
          {% else %}
            PRE ROUND
          {% endif %}
        </h2>
        <div class="round-counter regular2">
          Rounds Completed/Total:
          <span class="counter-value medium1">
            {{ completed_rounds }}/{{ tournament.total_rounds }}
          </span>
        </div>
      </div>

      {% if current_round and current_round.status == 'in progress' and view_state != 'confirm_results' %}
      <div class="round-controls">
        <div class="round-timer">
          <span class="timer-label medium2">Round Time Limit:</span>
          <span id="timerDisplay" class="timer-value regular3">{{ tournament.round_time_minutes }}:00</span>
        </div>
        <div class="Dialog">
          <button id="resetRoundBtn" class="cancel"
                  {% if readonly %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
            Reset Round
          </button>
        </div>
      </div>
      {% endif %}

      <!-- Pairings -->
      <div class="table-container">
        <div class="table-label">
          <h3 class="medium2 table-heading">PAIRINGS:</h3>
        </div>
        <div class="pairings-table-container">
          <div class="table-wrapper">
            <table class="pairings-table app-table">
              <thead>
                <tr>
                  <th>Table</th>
                  <th>Player 1</th>
                  <th>W/L</th>
                  <th>Player 2</th>
                  <th>W/L</th>
                  {% if (current_round and current_round.status == 'in progress') or view_state == 'confirm_results' %}
                  <th class="win-header">
                    {% if readonly %}Winner{% else %}Select Winner{% endif %}
                  </th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for match in current_matches %}
                {% set p1_stats = player_stats.get(match.player1_id, {'wins':0,'losses':0}) %}
                {% set p2_stats = player_stats.get(match.player2_id, {'wins':0,'losses':0}) if match.player2_id else None %}
                <tr class="match-row"
                    data-match-id="{{ match.id }}"
                    data-player1-id="{{ match.player1_id }}"
                    data-player2-id="{{ match.player2_id or '' }}"
                    data-winner-id="{{ match.winner_id or '' }}"
                    data-is-bye="{{ 'true' if match.is_bye else 'false' }}">
                  <td>{{ loop.index }}</td>
                  <td>
                    {% set p = players.get(match.player1_id) %}
                    {% if p and p.user_id %}{{ p.user.first_name }} {{ p.user.last_name }}{% elif p %}{{ p.guest_firstname }} {{ p.guest_lastname }}{% endif %}
                  </td>
                  <td>{{ p1_stats.wins }}/{{ p1_stats.losses }}</td>
                  <td>
                    {% if match.player2_id %}
                      {% set p = players.get(match.player2_id) %}
                      {% if p and p.user_id %}{{ p.user.first_name }} {{ p.user.last_name }}{% elif p %}{{ p.guest_firstname }} {{ p.guest_lastname }}{% endif %}
                    {% else %}BYE{% endif %}
                  </td>
                  <td>{{ match.player2_id and p2_stats.wins~'/'~p2_stats.losses or '-' }}</td>
                  {% if (current_round and current_round.status == 'in progress') or view_state == 'confirm_results' %}
                  <td class="winner-selection">
                    <div class="RadioSelection">
                      <label class="radio-option">
                        <input type="radio"
                               name="winner{{ match.id }}"
                               value="player1"
                               class="radio-input"
                               {% if match.is_bye %}checked disabled{% elif match.winner_id==match.player1_id %}checked{% endif %}
                               {% if readonly %}disabled{% endif %}>
                        <div class="radio-custom">
                          <div class="radio-icon">
                            <div class="unselected-icon RadialIcon"></div>
                            <div class="selected-icon RadialSelectedIcon"></div>
                          </div>
                          <span class="radio-label">P1</span>
                        </div>
                      </label>
                      {% if match.player2_id %}
                      <label class="radio-option">
                        <input type="radio"
                               name="winner{{ match.id }}"
                               value="player2"
                               class="radio-input"
                               {% if match.winner_id==match.player2_id %}checked{% endif %}
                               {% if readonly %}disabled{% endif %}>
                        <div class="radio-custom">
                          <div class="radio-icon">
                            <div class="unselected-icon RadialIcon"></div>
                            <div class="selected-icon RadialSelectedIcon"></div>
                          </div>
                          <span class="radio-label">P2</span>
                        </div>
                      </label>
                      {% endif %}
                    </div>
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Standings omitted for brevity... -->

      <!-- Footer Round Controls -->
      <div class="round-controls">
        <div class="round-timer">
          <span class="timer-label medium2">Round Time:</span>
          <span id="timerDisplay" class="timer-value">{{ tournament.round_time_minutes }}:00</span>
        </div>
        <div class="SendJoinBtn">
          <button id="endRoundEarlyBtn"
                  {% if readonly %}disabled class="opacity-50 cursor-not-allowed"{% endif %}>
            End Round Early
          </button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
