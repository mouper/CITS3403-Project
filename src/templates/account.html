{% extends "base.html" %}

{% block content %}
<h1 class="account-page-heading">My Account</h1>
<div class="account-page-container">
  <div class="top-section">
    <div class="ProfileSection">
      <div class="profile-top"></div>
      <div class="profile-avatar">
        <img id="avatarPreview" src="https://via.placeholder.com/150" alt="Avatar">
        <input type="file" id="avatarUpload" accept="image/*">
        <button class="edit-avatar-btn"><div class="EditIcon"></div></button>
      </div>
      <div class="profile-info">
        <h2 class="title2">{{ current_user.username }}</h2>
        <div class="email-display-line">
          <input type="email" class="email-input" value="{{ current_user.email }}" readonly>
          <button class="edit-icon-btn"><div class="EditIcon"></div></button>
        </div>
      </div>
      <div class="profile-bottom">
        <div class="player-details">
          <div class="AccountTextForm with-edit">
            <input type="text" value="{{ current_user.first_name }}" placeholder="First Name">
            <button class="edit-icon-btn"><div class="EditIcon"></div></button>
          </div>
          <div class="AccountTextForm with-edit">
            <input type="text" value="{{ current_user.last_name }}" placeholder="Last Name">
            <button class="edit-icon-btn"><div class="EditIcon"></div></button>
          </div>
        </div>
      </div>
    </div>

    <div class="settings-panel">
        <div class="settings-header">
          <h2 class="subheadline settings-title">Stats Displayed On My Profile:</h2>
          <div class="Dropdown player-dropdown">
            <select>
              <option>Player</option>
              <option>Admin</option>
            </select>
          </div>
        </div>
  
        <div class="switch-group">
          <div class="switch-card">
            <span class="medium4">Win Rate</span>
            <label class="switch">
              <input type="checkbox" checked>
              <span class="slider"></span>
            </label>
          </div>
  
          <div class="switch-card">
            <span class="medium4">Total Wins/Total Played</span>
            <label class="switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
  
          <div class="switch-card">
            <span class="medium4">Last 3 Tournaments</span>
            <label class="switch">
              <input type="checkbox">
              <span class="slider"></span>
            </label>
          </div>
  
          <div class="switch-card top3-card">
            <div class="top3-row">
              <span class="medium4">Top 3 Tournaments</span>
              <label class="switch">
                <input type="checkbox" checked>
                <span class="slider"></span>
              </label>
            </div>
  
            <div class="top3-tab-group">
              <button class="top3-tab">Highest Win Count</button>
              <button class="top3-tab">Highest Win Rate</button>
              <button class="top3-tab">Leaderboard Rank</button>
            </div>
  
            <div class="top3-subline">
                <span class="caption">Select Game Displayed</span>
                <select id="gameTypeSelect" class="medium4">
                  {% for game_type in game_types %}
                    <option value="{{ game_type }}">{{ game_type }}</option>
                  {% endfor %}
                </select>
            </div>   
        </div>
    </div>
  </div>

  <!-- PROFILE PREVIEW -->
  <div class="bottom-section">
    <h2 class="title2">Profile Preview:</h2>
    <div class="profile-preview-wrapper">
      <div class="preview-upper">
        <div class="preview-avatar-wrapper">
          <img src="https://via.placeholder.com/150" alt="Avatar" class="preview-avatar-img">
        </div>
      </div>

      <div class="preview-lower">
        {% set total_wins = user_stats | map(attribute='games_won') | sum %}
        {% set total_played = user_stats | map(attribute='games_played') | sum %}
        <div class="identity-stat-line">
            <div class="username">{{ current_user.username }}</div>
            <div class="stat-line-right">
              <span class="winrate" data-section="winrate">{{ total_winrate }}% WR</span>
              <span class="totalcount" data-section="totalcount">{{ total_wins }}/{{ total_played }}</span>
            </div>
        </div>
        
        <div class="last3-section" data-section="last3">
          <div class="top3-header">
            <span class="top3-title">LAST 3 TOURNAMENTS</span>
          </div>
          {% if last_3_results %}
            <div class="statcard-container">
            {% for result, tournament in last_3_results %}
            <div class="statcard">
                <div class="statcard-top-row">
                  <p class="subheadline">{{ loop.index }}.</p>
                  <p class="title2 purple-text">{{ result.wins }} WINS</p>
                </div>
                <div class="statcard-middle-row">
                  <p class="medium5">
                    {{ (result.wins / (result.wins + result.losses) * 100) | round(1) if (result.wins + result.losses) > 0 else 0 }}% WR
                  </p>
                  <p class="medium5">{{ result.opponent_win_percentage or 0 }}% OPWR%</p>
                  <p class="medium5">{{ result.opp_opp_win_percentage or 0 }}% OPOWR%</p>
                </div>
                <p class="medium4 italic tournament-type">{{ tournament.format }}</p>
                <p class="medium4">{{ tournament.title }}</p>
              </div>
            {% endfor %}
            </div>
          {% else %}
            <p class="medium4 italic">No recent tournaments found.</p>
          {% endif %}
        </div>
        
        <div class="statcard-wrapper" data-section="top3">
            {% for game_type, entries in grouped_results.items() %}
            <div class="top3-section" data-type="wins" data-game-type="{{ game_type }}">
              <div class="top3-header">
                <span class="top3-title">TOP 3 TOURNAMENTS: HIGHEST WIN COUNT</span>
                <span class="top3-game">{{ game_type }}</span>
              </div>
              <div class="statcard-container">
                {% for result, tournament in entries[:3] %}
                  <div class="statcard">
                    <div class="statcard-top-row">
                      <p class="subheadline">
                        {% if loop.index == 1 %}1st{% elif loop.index == 2 %}2nd{% elif loop.index == 3 %}3rd{% else %}{{ loop.index }}th{% endif %}
                      </p>
                      <p class="title2 purple-text">{{ result.wins }} WINS</p>
                    </div>
                    <div class="statcard-middle-row">
                      <p class="medium5">
                        {{ (result.wins / (result.wins + result.losses) * 100) | round(1) if (result.wins + result.losses) > 0 else 0 }}% WR
                      </p>
                      <p class="medium5">{{ result.opponent_win_percentage or 0 }}% OPWR%</p>
                      <p class="medium5">{{ result.opp_opp_win_percentage or 0 }}% OPOWR%</p>
                    </div>
                    <p class="medium4 italic tournament-type">{{ tournament.format }}</p>
                    <p class="medium4">{{ tournament.title }}</p>
                  </div>
                {% endfor %}
              </div>
            </div>
            {% else %}
              <p class="medium4 italic">No tournaments found.</p>
            {% endfor %} 

            <!-- Highest Win Rate -->
            {% for game_type, entries in grouped_by_winrate.items() %}
            <div class="top3-section" data-type="winrate" data-game-type="{{ game_type }}" style="display: none;">
              <div class="top3-header">
                <span class="top3-title">TOP 3 TOURNAMENTS: HIGHEST WIN RATE</span>
                <span class="top3-game">{{ game_type }}</span>
              </div>
              <div class="statcard-container">
              {% for result, tournament in entries[:3] %}
                <div class="statcard">
                  <div class="statcard-top-row">
                    <p class="subheadline">
                      {% if loop.index == 1 %}1st{% elif loop.index == 2 %}2nd{% elif loop.index == 3 %}3rd{% else %}{{ loop.index }}th{% endif %}
                    </p>
                    <p class="title2 purple-text">
                      {{ (result.wins / (result.wins + result.losses) * 100) | round(1) if (result.wins + result.losses) > 0 else 0 }}% WR
                    </p>
                  </div>
                  <div class="statcard-middle-row">
                    <p class="medium5">{{ result.wins }} Wins</p>
                    <p class="medium5">{{ result.opponent_win_percentage or 0 }}% OPWR%</p>
                    <p class="medium5">{{ result.opp_opp_win_percentage or 0 }}% OPOWR%</p>
                  </div>
                  <p class="medium4 italic tournament-type">{{ tournament.format }}</p>
                  <p class="medium4">{{ tournament.title }}</p>
                </div>
              {% endfor %}
              </div>
            </div>
            {% endfor %} 
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}









